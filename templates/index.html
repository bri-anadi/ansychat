<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Chat App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.2/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 h-screen">
    <!-- Login Form -->
    <div id="loginForm" class="min-h-screen flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-md w-96">
            <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Chat Login</h2>
            <div class="space-y-4">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                    <input type="text" id="username" name="username" 
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-blue-500 focus:ring focus:ring-blue-200">
                    <p id="usernameError" class="mt-1 text-sm text-red-600 hidden"></p>
                    <div id="usernameSuggestions" class="mt-2 space-y-2 hidden">
                        <p class="text-sm text-gray-600">Suggested usernames:</p>
                        <div id="suggestionsList" class="flex flex-wrap gap-2">
                            <!-- Suggestions will be inserted here -->
                        </div>
                    </div>
                </div>
                <button onclick="login()" 
                        class="w-full bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600 transition duration-200">
                    Login
                </button>
            </div>
        </div>
    </div>

    <!-- Chat Interface -->
    <div id="chatInterface" class="hidden h-screen flex flex-col">
        <!-- Header -->
        <div class="bg-blue-500 p-4 text-white flex justify-between items-center">
            <h1 class="text-xl font-bold">Chat Room</h1>
            <div class="flex items-center space-x-4">
                <span id="currentUser" class="font-medium"></span>
                <button onclick="logout()" 
                        class="bg-blue-600 px-4 py-2 rounded hover:bg-blue-700 transition duration-200">
                    Logout
                </button>
            </div>
        </div>

        <!-- Messages Area -->
        <div class="flex-1 overflow-y-auto p-4 space-y-4" id="messagesArea">
            <!-- Messages will be inserted here -->
        </div>

        <!-- Edit Message Modal -->
        <div id="editModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center">
            <div class="bg-white p-4 rounded-lg shadow-lg w-96">
                <h3 class="text-lg font-bold mb-4">Edit Message</h3>
                <input type="text" id="editMessageInput" class="w-full border rounded-md p-2 mb-4">
                <input type="hidden" id="editMessageId">
                <div class="flex justify-end space-x-2">
                    <button onclick="closeEditModal()" class="px-4 py-2 bg-gray-300 rounded-md hover:bg-gray-400">
                        Cancel
                    </button>
                    <button onclick="saveEditedMessage()" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">
                        Save
                    </button>
                </div>
            </div>
        </div>

        <!-- Message Input -->
        <div class="border-t p-4 bg-white">
            <div class="flex space-x-2">
                <input type="text" id="messageInput" 
                       class="flex-1 border rounded-md p-2 focus:border-blue-500 focus:ring focus:ring-blue-200" 
                       placeholder="Type your message...">
                <button onclick="sendMessage()" 
                        class="bg-blue-500 text-white px-6 py-2 rounded-md hover:bg-blue-600 transition duration-200">
                    Send
                </button>
            </div>
        </div>
    </div>

    <script>
        let token = null;
        let socket = null;
        let isCheckingUsername = false;

        // Initialize Socket.IO connection
        function initializeSocket() {
            socket = io();

            socket.on('connect', () => {
                console.log('Connected to Socket.IO server');
                socket.emit('join', { username: document.getElementById('currentUser').textContent });
            });

            socket.on('message', (message) => {
                appendMessage(message);
            });

            socket.on('message_edited', (data) => {
                const messageElement = document.getElementById(`message-content-${data.messageId}`);
                if (messageElement) {
                    messageElement.textContent = data.content;
                }
            });

            socket.on('message_deleted', (data) => {
                console.log('Received message_deleted event for message:', data.messageId);
                const messageElement = document.getElementById(`message-${data.messageId}`);
                console.log('Found element to delete:', messageElement);

                if (messageElement) {
                    messageElement.style.transition = 'all 0.3s ease';
                    messageElement.style.opacity = '0';
                    messageElement.style.height = '0';

                    setTimeout(() => {
                        messageElement.remove();
                        console.log('Message element removed from DOM');
                    }, 300);
                } else {
                    console.log('Message element not found in DOM');
                }
            });

            socket.on('user_joined', (data) => {
                appendSystemMessage(`${data.username} joined the chat`);
            });

            socket.on('user_left', (data) => {
                appendSystemMessage(`${data.username} left the chat`);
            });
        }

        function showSuggestions(suggestions) {
            const suggestionsContainer = document.getElementById('usernameSuggestions');
            const suggestionsList = document.getElementById('suggestionsList');

            if (suggestions && suggestions.length > 0) {
                suggestionsList.innerHTML = suggestions.map(suggestion => `
                    <button
                        onclick="selectSuggestion('${suggestion}')"
                        class="px-3 py-1 text-sm bg-blue-100 text-blue-700 rounded-full hover:bg-blue-200 transition-colors"
                    >
                        ${suggestion}
                    </button>
                `).join('');
                suggestionsContainer.classList.remove('hidden');
            } else {
                suggestionsContainer.classList.add('hidden');
            }
        }

        function selectSuggestion(username) {
            document.getElementById('username').value = username;
            document.getElementById('usernameSuggestions').classList.add('hidden');
            login();
        }

        async function checkUsername(username) {
            if (!username || username.trim().length === 0) {
                showUsernameError('Username cannot be empty');
                showSuggestions([]);
                return false;
            }

            try {
                const response = await axios.post('/api/check-username', { username });
                hideUsernameError();
                showSuggestions([]);
                return true;
            } catch (error) {
                if (error.response) {
                    showUsernameError(error.response.data.message || 'Username is not available');
                    showSuggestions(error.response.data.suggestions || []);
                } else {
                    showUsernameError('Error checking username availability');
                    showSuggestions([]);
                }
                return false;
            }
        }

        function showUsernameError(message) {
            const errorElement = document.getElementById('usernameError');
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
        }

        function hideUsernameError() {
            const errorElement = document.getElementById('usernameError');
            errorElement.classList.add('hidden');
        }

        let usernameCheckTimeout;
        function handleUsernameInput(event) {
            clearTimeout(usernameCheckTimeout);
            const username = event.target.value.trim();

            if (username.length > 0) {
                usernameCheckTimeout = setTimeout(() => checkUsername(username), 500);
            } else {
                showUsernameError('Username cannot be empty');
                showSuggestions([]);
            }
        }
        
        document.getElementById('username').addEventListener('input', handleUsernameInput);

        async function login() {
            const username = document.getElementById('username').value.trim();

            if (isCheckingUsername) return;
            isCheckingUsername = true;

            try {
                // First check if username is available
                const isAvailable = await checkUsername(username);
                if (!isAvailable) {
                    isCheckingUsername = false;
                    return;
                }

                // If username is available, proceed with login
                const response = await axios.post('/api/login', { username });
                token = response.data.access_token;
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('chatInterface').classList.remove('hidden');
                document.getElementById('currentUser').textContent = username;
                initializeSocket();
                loadMessages();
            } catch (error) {
                if (error.response && error.response.status === 409) {
                    showUsernameError('Username is already in use');
                    showSuggestions(error.response.data.suggestions || []);
                } else {
                    showUsernameError('Login failed: ' + (error.response?.data?.error || error.message));
                }
            } finally {
                isCheckingUsername = false;
            }
        }

        function logout() {
            if (socket) {
                socket.emit('leave', { username: document.getElementById('currentUser').textContent });
                socket.disconnect();
            }
            token = null;
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('chatInterface').classList.add('hidden');
            document.getElementById('username').value = '';
            document.getElementById('messagesArea').innerHTML = '';
        }

        async function loadMessages() {
            try {
                const response = await axios.get('/api/messages', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const messagesArea = document.getElementById('messagesArea');
                messagesArea.innerHTML = '';
                response.data.forEach(message => {
                    appendMessage(message);
                });
            } catch (error) {
                console.error('Failed to load messages:', error);
            }
        }

        function appendMessage(message) {
            const messagesArea = document.getElementById('messagesArea');
            const isCurrentUser = message.username === document.getElementById('currentUser').textContent;
            const messageElement = document.createElement('div');
    
            // Make sure this ID is set correctly
            messageElement.id = `message-${message.id}`;
            console.log(`Creating message element with ID: message-${message.id}`);

            messageElement.className = `flex ${isCurrentUser ? 'justify-end' : 'justify-start'}`;

            messageElement.innerHTML = `
                <div class="max-w-[70%] ${isCurrentUser ? 'bg-blue-500 text-white' : 'bg-gray-200'} rounded-lg p-3 relative group">
                    <div class="font-medium text-sm ${isCurrentUser ? 'text-blue-100' : 'text-gray-600'}">${message.username}</div>
                    <div class="break-words" id="message-content-${message.id}">${message.content}</div>
                    <div class="text-xs ${isCurrentUser ? 'text-blue-100' : 'text-gray-500'} mt-1">
                        ${new Date(message.timestamp).toLocaleString()}
                    </div>
                    ${isCurrentUser ? `
                        <div class="absolute top-2 right-2 hidden group-hover:flex space-x-2">
                            <button onclick="showEditModal(${message.id}, '${message.content}')" 
                                    class="text-white hover:text-blue-200 transition-colors">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteMessage(${message.id})" 
                                    class="text-white hover:text-blue-200 transition-colors">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;

            messagesArea.appendChild(messageElement);
            messagesArea.scrollTop = messagesArea.scrollHeight;
            console.log(`Message ${message.id} appended to DOM`);
        }
        
        function appendSystemMessage(content) {
            const messagesArea = document.getElementById('messagesArea');
            const messageElement = document.createElement('div');
            messageElement.className = 'flex justify-center';
            messageElement.innerHTML = `
                <div class="max-w-[70%] bg-gray-100 rounded-lg p-2">
                    <div class="text-sm text-gray-500 text-center">${content}</div>
                </div>
            `;
            messagesArea.appendChild(messageElement);
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const content = messageInput.value.trim();
            if (!content) return;

            const username = document.getElementById('currentUser').textContent;
            socket.emit('new_message', {
                username: username,
                content: content,
                token: token
            });

            messageInput.value = '';
        }

        // Edit message functions
        function showEditModal(messageId, content) {
            document.getElementById('editModal').classList.remove('hidden');
            document.getElementById('editMessageInput').value = content;
            document.getElementById('editMessageId').value = messageId;
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
        }

        async function saveEditedMessage() {
            const messageId = document.getElementById('editMessageId').value;
            const newContent = document.getElementById('editMessageInput').value.trim();
            if (!newContent) return;

            try {
                await axios.put(`/api/messages/${messageId}`, 
                    { content: newContent },
                    { headers: { 'Authorization': `Bearer ${token}` }}
                );

                socket.emit('edit_message', {
                    messageId: messageId,
                    content: newContent,
                    username: document.getElementById('currentUser').textContent,
                    token: token
                });

                closeEditModal();
            } catch (error) {
                console.error('Failed to edit message:', error);
                alert('Failed to edit message');
            }
        }

        async function deleteMessage(messageId) {
            if (!confirm('Are you sure you want to delete this message?')) return;

            try {
                console.log('Starting deletion process for message:', messageId);

                // Tambahkan visual feedback
                const messageElement = document.getElementById(`message-${messageId}`);
                if (messageElement) {
                    messageElement.style.opacity = '0.5';
                }

                // Delete dari server
                const response = await axios.delete(`/api/messages/${messageId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                console.log('Server deletion successful, emitting socket event');

                // Emit socket event untuk delete
                socket.emit('delete_message', {
                    messageId: messageId,
                    username: document.getElementById('currentUser').textContent,
                    token: token
                });

                console.log('Socket delete event emitted');

            } catch (error) {
                console.error('Error deleting message:', error);
                // Restore opacity jika gagal
                if (messageElement) {
                    messageElement.style.opacity = '1';
                }
                alert('Failed to delete message');
            }
        }

        // Handle Enter key in message input
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Handle Enter key in username input
        document.getElementById('username').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                login();
            }
        });

        // Handle Enter key in edit message input
        document.getElementById('editMessageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                saveEditedMessage();
            }
        });
    </script>
</body>
</html>